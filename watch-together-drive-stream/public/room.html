<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Watch Together - Drive Stream</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: 'Helvetica Neue', sans-serif; background: #141414; color: #fff; margin: 0; padding: 0; }
    header { background: #000; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; color: red; }
    #container { padding: 20px; text-align: center; }
    iframe { width: 80%; height: 480px; border: 3px solid #fff; border-radius: 10px; }
    #chat-box { width: 80%; margin: 20px auto; background: #1f1f1f; padding: 10px; height: 250px; overflow-y: scroll; border-radius: 10px; text-align: left; }
    .message { background: #333; margin: 5px; padding: 8px 12px; border-radius: 10px; display: inline-block; max-width: 80%; }
    .me { background-color: #005c4b; color: #fff; margin-left: auto; display: block; }
    .them { background-color: #444; }
    #controls { margin-top: 10px; }
    input, button { padding: 10px; border-radius: 5px; border: none; font-size: 16px; }
    #videoUrl { width: 60%; }
    #messageInput { width: 60%; margin-top: 10px; }
    button { background-color: red; color: white; cursor: pointer; }
  </style>
</head>
<body>
  <header>Watch Together</header>
  <div id="container">
    <input id="videoUrl" type="text" placeholder="Paste Google Drive /preview link..." />
    <button onclick="loadIframe()">Load Video</button><br><br>
    <iframe id="videoFrame" allowfullscreen></iframe>
    
    <div id="controls">
      <button onclick="syncAction('play')">▶️ Play</button>
      <button onclick="syncAction('pause')">⏸️ Pause</button>
      <input id="seekTime" type="number" placeholder="Time in seconds" style="width: 150px;" />
      <button onclick="syncSeek()">⏩ Seek</button>
    </div>

    <div id="chat-box"></div>
    <input id="messageInput" placeholder="Type message..." />
    <button onclick="sendMessage()">Send</button>
  </div>

  <script>
    const socket = io();
    const roomId = window.location.pathname.split('/')[2];
    const chatBox = document.getElementById('chat-box');
    const iframe = document.getElementById('videoFrame');

    socket.emit('join-room', { roomId });

    function loadIframe() {
      const url = document.getElementById('videoUrl').value;
      if (url.includes('/preview')) {
        iframe.src = url;
      } else {
        alert("Use the /preview link format from Google Drive.");
      }
    }

    function syncAction(action) {
      socket.emit('iframe-sync', { roomId, action });
    }

    function syncSeek() {
      const time = parseFloat(document.getElementById('seekTime').value);
      if (!isNaN(time)) {
        socket.emit('iframe-sync', { roomId, action: 'seek', time });
      }
    }

    socket.on('iframe-sync', ({ action, time }) => {
      const frame = iframe.contentWindow;
      if (frame) {
        frame.postMessage({ action, time }, '*');
      }
    });

    function sendMessage() {
      const msg = document.getElementById('messageInput').value.trim();
      if (msg) {
        appendMessage(msg, true);
        socket.emit('chat-message', { roomId, message: msg });
        document.getElementById('messageInput').value = '';
      }
    }

    socket.on('chat-message', (msg) => {
      appendMessage(msg, false);
    });

    function appendMessage(msg, isMe) {
      const div = document.createElement('div');
      div.className = 'message ' + (isMe ? 'me' : 'them');
      div.textContent = (isMe ? 'You: ' : 'Friend: ') + msg;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>
</body>
</html>